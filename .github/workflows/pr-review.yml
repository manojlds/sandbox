name: DRS PR Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

jobs:
  # First, verify if the contributor is trusted
  verify-contributor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is-trusted: ${{ steps.check.outputs.is-trusted }}
      has-review-label: ${{ steps.check.outputs.has-review-label }}
    steps:
      - name: Check contributor status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR author is a repository member or collaborator
          AUTHOR="${{ github.event.pull_request.user.login }}"
          REPO="${{ github.repository }}"

          echo "Checking if $AUTHOR is a trusted contributor..."

          # Check organization membership or repository collaborator status
          if gh api "/repos/$REPO/collaborators/$AUTHOR" --silent 2>/dev/null; then
            echo "âœ… $AUTHOR is a repository collaborator"
            echo "is-trusted=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  $AUTHOR is an external contributor"
            echo "is-trusted=false" >> $GITHUB_OUTPUT
          fi

          # Check if PR has the safe-to-review label
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -q "safe-to-review"; then
            echo "âœ… PR has 'safe-to-review' label"
            echo "has-review-label=true" >> $GITHUB_OUTPUT
          else
            echo "has-review-label=false" >> $GITHUB_OUTPUT
          fi

  # Auto-review for trusted contributors (repository members/collaborators)
  review-trusted:
    runs-on: ubuntu-latest
    needs: verify-contributor
    if: needs.verify-contributor.outputs.is-trusted == 'true'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch for git diff
        run: |
          # Fetch the base branch to make origin/<base> available for git diff
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenCode CLI
        run: npm install -g opencode-ai

      - name: Install DRS
        run: npm install -g @diff-review-system/drs

      - name: Setup OpenCode Zen Authentication
        if: env.OPENCODE_ZEN_API_KEY != ''
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          echo "ðŸ”‘ Setting up OpenCode Zen authentication..."
          mkdir -p ~/.local/share/opencode
          cat > ~/.local/share/opencode/auth.json <<EOF
          {
            "opencode": {
              "type": "api",
              "key": "${OPENCODE_ZEN_API_KEY}"
            }
          }
          EOF
          echo "âœ… OpenCode Zen auth.json created"

      - name: Review Pull Request (Trusted Contributor)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          echo "ðŸš€ Starting PR review for trusted contributor..."
          echo "ðŸ‘¤ Author: ${{ github.event.pull_request.user.login }} (trusted)"

          drs review-pr \
            --owner ${{ github.event.repository.owner.login }} \
            --repo ${{ github.event.repository.name }} \
            --pr ${{ github.event.pull_request.number }} \
            --post-comments \
            --debug

  # Review for external contributors - requires environment approval OR safe-to-review label
  review-external:
    runs-on: ubuntu-latest
    needs: verify-contributor
    if: |
      needs.verify-contributor.outputs.is-trusted == 'false' &&
      needs.verify-contributor.outputs.has-review-label == 'true'
    # Use protected environment for manual approval gate
    # Repository admins must configure this environment in Settings > Environments
    environment: external-pr-review
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Fetch base branch for git diff
        run: |
          # Fetch the base branch to make origin/<base> available for git diff
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OpenCode CLI
        run: npm install -g opencode-ai

      - name: Install DRS
        run: npm install -g @diff-review-system/drs

      - name: Setup OpenCode Zen Authentication
        if: env.OPENCODE_ZEN_API_KEY != ''
        env:
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          echo "ðŸ”‘ Setting up OpenCode Zen authentication..."
          mkdir -p ~/.local/share/opencode
          cat > ~/.local/share/opencode/auth.json <<EOF
          {
            "opencode": {
              "type": "api",
              "key": "${OPENCODE_ZEN_API_KEY}"
            }
          }
          EOF
          echo "âœ… OpenCode Zen auth.json created"

      - name: Review Pull Request (External Contributor)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
        run: |
          echo "ðŸš€ Starting PR review for external contributor..."
          echo "ðŸ‘¤ Author: ${{ github.event.pull_request.user.login }} (external - approved)"

          drs review-pr \
            --owner ${{ github.event.repository.owner.login }} \
            --repo ${{ github.event.repository.name }} \
            --pr ${{ github.event.pull_request.number }} \
            --post-comments \
            --debug

  # Notify when external PR is waiting for approval
  notify-external:
    runs-on: ubuntu-latest
    needs: verify-contributor
    if: |
      needs.verify-contributor.outputs.is-trusted == 'false' &&
      needs.verify-contributor.outputs.has-review-label == 'false'
    permissions:
      pull-requests: write

    steps:
      - name: Post notification comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body "ðŸ‘‹ Thanks for your contribution!

          Since this is from an external contributor, automated review requires approval from a repository maintainer.

          **Maintainers:** To trigger the automated review, either:
          1. Add the \`safe-to-review\` label to this PR
          2. Approve the workflow run in the Actions tab

          This helps prevent abuse and protects API costs. Thank you for understanding! ðŸ™"
